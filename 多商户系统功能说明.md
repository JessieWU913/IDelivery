# 多商户外卖系统 - 功能实现说明

## 📋 已实现功能列表

### 一、商户管理系统 ✅

#### 1. 商户登录与仪表板
- ✅ 商户账号登录(roleId=3)
- ✅ 自动跳转到商户管理页面(`/merchant/index`)
- ✅ 显示商户基本信息(店铺名称、地址、电话、营业时间)
- ✅ 显示统计数据(菜品数量、总销售额、评分)
- ✅ 显示商户所有菜品列表

#### 2. 菜品管理功能
- ✅ **添加菜品** (`/merchant/product/add`)
  - 选择分类
  - 填写菜品信息(名称、描述、价格、原价、库存、图片)
  - 设置推荐和上架状态
  - 自动关联到当前商户

- ✅ **编辑菜品** (`/merchant/product/edit/{id}`)
  - 修改菜品信息
  - 权限验证:只能编辑自己的菜品
  - 更新后自动刷新列表

- ✅ **删除菜品** (`/merchant/product/delete/{id}`)
  - 删除确认提示
  - 权限验证:只能删除自己的菜品
  - AJAX异步删除

- ✅ **菜品列表** (`/merchant/products`)
  - 分类筛选
  - 搜索功能
  - 批量操作

### 二、用户浏览系统 ✅

#### 1. 商户信息展示
- ✅ 每个菜品卡片显示所属商户名称
- ✅ 商户图标标识
- ✅ 商户地址信息(下拉选择时显示)

#### 2. 商户筛选功能
- ✅ 商户下拉选择器
- ✅ 显示所有营业中的商户
- ✅ 筛选指定商户的菜品
- ✅ "全部商户"选项

#### 3. 排序功能
- ✅ **按商户排序**(默认) - 按商户名称拼音排序
- ✅ **按销量排序** - 销量从高到低
- ✅ **价格从低到高**
- ✅ **价格从高到低**

#### 4. 组合筛选
- ✅ 分类 + 商户 组合筛选
- ✅ 搜索 + 商户 组合筛选
- ✅ 排序 + 筛选 联动

### 三、购物车系统 ✅

#### 1. 按商户分组显示
- ✅ 购物车商品按商户分组
- ✅ 每个商户一个独立区域
- ✅ 商户名称标题栏
- ✅ 同一商户的商品聚合显示

#### 2. 商户信息关联
- ✅ Cart实体添加merchantId和merchantName字段
- ✅ CartMapper查询时LEFT JOIN merchant表
- ✅ 按商户名称排序显示

#### 3. 购物车功能
- ✅ 查看购物车商品
- ✅ 修改商品数量
- ✅ 删除单个商品
- ✅ 清空购物车
- ✅ 总价计算

## 🗄️ 数据库设计

### 新增表: t_merchant (商户表)
```sql
CREATE TABLE t_merchant (
    merchant_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '关联用户ID',
    merchant_name VARCHAR(100) NOT NULL COMMENT '商户名称',
    description VARCHAR(500) COMMENT '商户简介',
    logo VARCHAR(255) COMMENT '商户Logo',
    address VARCHAR(255) COMMENT '商户地址',
    phone VARCHAR(20) COMMENT '联系电话',
    business_hours VARCHAR(100) COMMENT '营业时间',
    status TINYINT DEFAULT 1 COMMENT '状态:1营业中,0休息中',
    rating DECIMAL(3,2) DEFAULT 5.0 COMMENT '评分',
    sales INT DEFAULT 0 COMMENT '总销量',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 修改表: t_product (菜品表)
```sql
ALTER TABLE t_product ADD COLUMN merchant_id BIGINT COMMENT '商户ID';
ALTER TABLE t_product ADD INDEX idx_merchant_id (merchant_id);
```

### 测试数据
- merchant001/123456 - 川香阁(四川菜)
- merchant002/123456 - 粤味轩(粤菜)
- merchant003/123456 - 江南小厨(江浙菜)

## 📁 文件结构

### 后端Java文件
```
src/main/java/cs/qqq/
├── Entity/
│   ├── Merchant.java                    (商户实体)
│   ├── Product.java                     (添加merchantId, merchantName字段)
│   └── Cart.java                        (添加merchantId, merchantName字段)
├── Mapper/
│   ├── MerchantMapper.java             (商户Mapper接口)
│   ├── ProductMapper.java              (添加按商户查询方法)
│   └── CartMapper.java                 (购物车Mapper)
├── Service/
│   ├── MerchantService.java            (商户Service接口)
│   ├── MerchantServiceImpl.java        (商户Service实现)
│   ├── ProductService.java             (添加商户相关方法)
│   └── ProductServiceImpl.java
└── Controller/
    ├── MerchantController.java         (商户管理控制器)
    ├── ProductController.java          (添加merchants列表)
    ├── CartController.java             (购物车按商户分组)
    └── LoginController.java            (添加商户角色路由)
```

### Mapper XML文件
```
src/main/resources/mapper/
├── MerchantMapper.xml                  (商户SQL映射)
├── ProductMapper.xml                   (所有查询添加merchant JOIN)
└── CartMapper.xml                      (购物车查询添加merchant JOIN)
```

### 前端模板文件
```
src/main/resources/templates/
├── merchant/
│   ├── index.html                      (商户仪表板)
│   ├── product_add.html                (添加菜品页面)
│   ├── product_edit.html               (编辑菜品页面)
│   └── product_list.html               (菜品管理列表)
├── menu/
│   └── index.html                      (用户菜单-添加商户筛选和排序)
└── cart/
    └── index.html                      (购物车-按商户分组显示)
```

## 🎯 核心功能说明

### 1. 商户菜品管理
商户只能管理自己的菜品,通过session中的userId查找对应的merchant_id,所有操作都验证权限。

```java
// 权限验证示例
Merchant merchant = merchantService.findByUserId(currentUser.getUserId());
Product product = productService.findById(productId);
if (!product.getMerchantId().equals(merchant.getMerchantId())) {
    return "无权操作此菜品";
}
```

### 2. 用户浏览商户菜品
- 默认按商户名称排序显示
- 可通过下拉框筛选特定商户
- 支持分类、搜索、排序多维度组合

```javascript
// 综合筛选逻辑
function filterAndSort() {
    // 1. 按分类筛选
    // 2. 按商户筛选
    // 3. 应用排序规则
    // 4. 显示结果
}
```

### 3. 购物车按商户分组
购物车商品按商户聚合显示,方便用户查看每个商户的订单明细。

```java
// 按商户分组
Map<String, List<Cart>> cartByMerchant = new LinkedHashMap<>();
for (Cart cart : cartList) {
    String key = cart.getMerchantId() + "_" + cart.getMerchantName();
    cartByMerchant.computeIfAbsent(key, k -> new ArrayList<>()).add(cart);
}
```

## 🚀 使用说明

### 商户端使用流程
1. 使用商户账号登录(merchant001/123456)
2. 进入商户仪表板,查看店铺信息和统计
3. 点击"添加新菜品"创建菜品
4. 在菜品列表中编辑或删除菜品
5. 查看菜品销售数据

### 用户端使用流程
1. 登录用户账号(user001/123456)
2. 浏览菜单,默认按商户分组显示
3. 使用商户筛选器选择特定商户
4. 选择排序方式(按商户/销量/价格)
5. 添加商品到购物车
6. 查看购物车,商品按商户分组显示

## 📊 数据关系图

```
sys_user (用户表)
    ├── roleId = 1,2 → 管理员
    ├── roleId = 3 → 商户 → t_merchant (商户表)
    └── roleId = 5 → 普通用户

t_merchant (商户表)
    └── merchant_id → t_product.merchant_id (菜品关联)

t_product (菜品表)
    ├── merchant_id → 所属商户
    └── category_id → 菜品分类

t_cart (购物车)
    ├── product_id → 菜品
    └── 查询时JOIN merchant获取商户信息
```

## ✨ 技术特点

1. **权限控制**: 商户只能操作自己的菜品
2. **级联查询**: 所有Product查询自动LEFT JOIN merchant表
3. **数据分组**: 购物车按商户智能分组
4. **排序优化**: 支持多种排序方式,默认按商户排序
5. **用户体验**: 商户信息实时显示,筛选响应快速
6. **代码复用**: 统一的Service层和Mapper层设计

## 🔧 待优化功能

- [ ] 商户评分和评论系统
- [ ] 商户营业时间判断
- [ ] 配送范围设置
- [ ] 商户佣金结算
- [ ] 订单按商户拆分
- [ ] 多商户配送费计算

---

**开发日期**: 2025-11-10  
**版本**: v1.0  
**状态**: 已完成核心功能 ✅
