<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>éª‘æ‰‹ç®¡ç† - é…é€ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/back/css/bootstrap.min.css">
    <link rel="stylesheet" href="/back/css/font-awesome.min.css">
    <link rel="stylesheet" href="/back/css/style.min.css">
    <script src="/assets/js/jquery.min.js"></script>
    <style>
        body {
            background: #f5f5f5;
        }

        .rider-container {
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .order-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .order-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .order-info {
            flex: 1;
        }

        .order-no {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .order-time {
            font-size: 14px;
            color: #999;
        }

        .order-status {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            background: #cce5ff;
            color: #004085;
        }

        .merchant-name {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .delivery-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .delivery-info-item {
            margin: 8px 0;
            color: #666;
        }

        .delivery-info-item strong {
            color: #333;
            margin-right: 10px;
        }

        .order-items {
            margin: 15px 0;
        }

        .order-item-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-item-row:last-child {
            border-bottom: none;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .order-total {
            font-size: 18px;
            font-weight: bold;
            color: #ff6b6b;
        }

        .order-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .empty-orders {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-orders-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="rider-container">
    <div class="page-header">
        <h2>ğŸ›µ éª‘æ‰‹é…é€ç®¡ç†</h2>
        <div>
            <button class="btn btn-secondary" onclick="location.reload()">
                <i class="fa fa-refresh"></i> åˆ·æ–°
            </button>
            <form action="/logout" method="post" style="display: inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-danger">
                    <i class="fa fa-sign-out"></i> é€€å‡ºç™»å½•
                </button>
            </form>
        </div>
    </div>

    <!-- è®¢å•åˆ—è¡¨ -->
    <div th:if="${availableOrders == null || availableOrders.size() == 0}" class="empty-orders">
        <div class="empty-orders-icon">ğŸ“¦</div>
        <h3>æš‚æ— å¾…é…é€è®¢å•</h3>
        <p>æ‰€æœ‰è®¢å•éƒ½å·²é…é€å®Œæˆæˆ–æ­£åœ¨å¤„ç†ä¸­</p>
    </div>

    <div th:if="${availableOrders != null && availableOrders.size() > 0}">
        <div th:each="order : ${availableOrders}" class="order-item">
            <div class="order-header">
                <div class="order-info">
                    <div class="order-no">è®¢å•å·ï¼š<span th:text="${order.orderNo}">ORDER123456</span></div>
                    <div class="order-time">ä¸‹å•æ—¶é—´ï¼š<span th:text="${#temporals.format(order.createTime, 'yyyy-MM-dd HH:mm:ss')}">2025-11-10 12:00:00</span></div>
                </div>
                <div class="order-status">é…é€ä¸­</div>
            </div>

            <div th:if="${acceptedOrderIds != null && acceptedOrderIds.contains(order.orderId)}" 
                 style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 10px; text-align: center; font-weight: bold;">
                âœ“ æ‚¨å·²æ¥å•æ­¤è®¢å•
            </div>

            <div class="merchant-name">ğŸª å•†æˆ·ï¼š<span th:text="${order.merchantName}">å•†æˆ·åç§°</span></div>

            <!-- é…é€ä¿¡æ¯ -->
            <div class="delivery-info">
                <div class="delivery-info-item">
                    <strong>é…é€åœ°å€ï¼š</strong>
                    <span th:text="${order.deliveryAddress}">é…é€åœ°å€</span>
                </div>
                <div class="delivery-info-item">
                    <strong>è”ç³»äººï¼š</strong>
                    <span th:text="${order.contactName}">è”ç³»äºº</span>
                </div>
                <div class="delivery-info-item">
                    <strong>è”ç³»ç”µè¯ï¼š</strong>
                    <span th:text="${order.contactPhone}">è”ç³»ç”µè¯</span>
                </div>
                <div class="delivery-info-item" th:if="${order.deliveryTime != null}">
                    <strong>é¢„è®¡é€è¾¾ï¼š</strong>
                    <span th:text="${#temporals.format(order.deliveryTime, 'yyyy-MM-dd HH:mm')}">2025-11-10 13:00</span>
                </div>
            </div>

            <!-- è®¢å•å•†å“ -->
            <div class="order-items" th:if="${order.orderItems != null && order.orderItems.size() > 0}">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333;">è®¢å•å•†å“ï¼š</div>
                <div th:each="item : ${order.orderItems}" class="order-item-row">
                    <span th:text="${item.productName}">å•†å“åç§°</span>
                    <span>x<span th:text="${item.quantity}">1</span></span>
                    <span>Â¥<span th:text="${#numbers.formatDecimal(item.subtotal, 1, 2)}">0.00</span></span>
                </div>
            </div>

            <div class="order-footer">
                <div class="order-total">
                    å®ä»˜ï¼šÂ¥<span th:text="${#numbers.formatDecimal(order.actualAmount, 1, 2)}">0.00</span>
                </div>
                <div class="order-actions">
                    <button th:if="${acceptedOrderIds == null || !acceptedOrderIds.contains(order.orderId)}"
                            class="btn btn-primary"
                            th:onclick="'acceptOrder(' + ${order.orderId} + ')'">æ¥å•</button>
                    <button th:if="${acceptedOrderIds != null && acceptedOrderIds.contains(order.orderId)}"
                            class="btn btn-success"
                            th:onclick="'completeDelivery(' + ${order.orderId} + ')'">å·²é€è¾¾</button>
                    <span th:if="${acceptedOrderIds != null && acceptedOrderIds.contains(order.orderId)}"
                          style="color: #28a745; font-weight: bold; margin-left: 10px;">âœ“ å·²æ¥å•</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    $(document).ajaxSend(function(e, xhr, options) {
        xhr.setRequestHeader(header, token);
    });

    function acceptOrder(orderId) {
        if (!confirm('ç¡®è®¤æ¥å•å—ï¼Ÿæ¥å•åæ‚¨å°†è´Ÿè´£é…é€æ­¤è®¢å•ã€‚')) return;
        $.ajax({
            url: '/rider/order/accept/' + orderId,
            type: 'POST',
            success: function(res) {
                if (res.success) {
                    alert('æ¥å•æˆåŠŸï¼è¯·å°½å¿«å‰å¾€å•†æˆ·å–é¤å¹¶é…é€ã€‚');
                    location.reload();
                } else {
                    alert(res.message || 'æ¥å•å¤±è´¥');
                }
            },
            error: function() {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        });
    }

    function completeDelivery(orderId) {
        if (!confirm('ç¡®è®¤å·²é€è¾¾å—ï¼Ÿé€è¾¾åè®¢å•å°†å˜ä¸ºå·²å®ŒæˆçŠ¶æ€ã€‚')) return;
        $.ajax({
            url: '/rider/order/deliver/' + orderId,
            type: 'POST',
            success: function(res) {
                if (res.success) {
                    alert('é€è¾¾æˆåŠŸï¼è®¢å•å·²å®Œæˆã€‚');
                    location.reload();
                } else {
                    alert(res.message || 'æ“ä½œå¤±è´¥');
                }
            },
            error: function() {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        });
    }
    
    // éª‘æ‰‹ç«¯è½®è¯¢æ£€æŸ¥æ–°è®¢å•
    let pollInterval;
    function startPolling() {
        pollInterval = setInterval(() => {
            $.ajax({
                url: '/rider/checkNewOrders',
                type: 'GET',
                success: function(res) {
                    if (res.needLogin) {
                        clearInterval(pollInterval);
                        alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                        location.href = '/login.html';
                        return;
                    }
                    if (res.success && res.hasNew) {
                        // æœ‰æ–°è®¢å•ï¼Œåˆ·æ–°é¡µé¢
                        location.reload();
                    }
                },
                error: function() {
                    // å‘ç”Ÿé”™è¯¯æ—¶åœæ­¢è½®è¯¢
                    clearInterval(pollInterval);
                }
            });
        }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    }
    
    // é¡µé¢åŠ è½½æ—¶å¯åŠ¨è½®è¯¢
    $(document).ready(function() {
        startPolling();
    });
    
    // é¡µé¢å…³é—­æ—¶åœæ­¢è½®è¯¢
    window.addEventListener('beforeunload', function() {
        if (pollInterval) clearInterval(pollInterval);
    });
</script>
</body>
</html>


