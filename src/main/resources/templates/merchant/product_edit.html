<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>编辑菜品</title>
    
    <link rel="stylesheet" th:href="@{/back/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/back/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/back/css/style.min.css}">
</head>
<body>
    <div id="wrapper">
        <div id="page-wrapper" class="gray-bg">
            <div class="row wrapper border-bottom white-bg page-heading">
                <div class="col-lg-10">
                    <h2>编辑菜品</h2>
                    <ol class="breadcrumb">
                        <li><a th:href="@{/merchant/index}">商户中心</a></li>
                        <li><a th:href="@{/merchant/products}">菜品管理</a></li>
                        <li class="active">编辑菜品</li>
                    </ol>
                </div>
            </div>

            <div class="wrapper wrapper-content">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox">
                            <div class="ibox-content">
                                <form id="productForm" class="form-horizontal">
                                    <input type="hidden" id="productId" th:value="${product.productId}">
                                    
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">菜品名称</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" id="productName" 
                                                   th:value="${product.productName}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">菜品分类</label>
                                        <div class="col-sm-10">
                                            <select class="form-control" id="categoryId" required>
                                                <option value="">请选择分类</option>
                                                <option th:each="category : ${categories}" 
                                                        th:value="${category.categoryId}" 
                                                        th:text="${category.categoryName}"
                                                        th:selected="${category.categoryId == product.categoryId}">分类</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">菜品描述</label>
                                        <div class="col-sm-10">
                                            <textarea class="form-control" id="productDesc" rows="3" 
                                                      th:text="${product.productDesc}"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">价格(元)</label>
                                        <div class="col-sm-10">
                                            <input type="number" step="0.01" class="form-control" id="price" 
                                                   th:value="${product.price}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">原价(元)</label>
                                        <div class="col-sm-10">
                                            <input type="number" step="0.01" class="form-control" id="originalPrice" 
                                                   th:value="${product.originalPrice}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">库存</label>
                                        <div class="col-sm-10">
                                            <input type="number" class="form-control" id="stock" 
                                                   th:value="${product.stock}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">图片URL</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" id="productImg" 
                                                   th:value="${product.productImg}">
                                            <small class="text-muted">请输入图片路径，如：/img/product/gongbao.jpg</small>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">是否推荐</label>
                                        <div class="col-sm-10">
                                            <select class="form-control" id="isRecommend">
                                                <option value="0" th:selected="${product.isRecommend == '0' || product.isRecommend == null}">否</option>
                                                <option value="1" th:selected="${product.isRecommend == '1'}">是</option>
                                            </select>
                                            <small class="text-muted">推荐菜品会在首页优先显示</small>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">状态</label>
                                        <div class="col-sm-10">
                                            <select class="form-control" id="status">
                                                <option value="1" th:selected="${product.status == '1'}">上架</option>
                                                <option value="0" th:selected="${product.status == '0'}">下架</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group" id="imagePreviewGroup" th:if="${product.productImg != null && product.productImg != ''}">
                                        <label class="col-sm-2 control-label">图片预览</label>
                                        <div class="col-sm-10">
                                            <img id="imagePreview" th:src="${product.productImg}" alt="图片预览" 
                                                 style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 5px; padding: 5px;">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="col-sm-offset-2 col-sm-10">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fa fa-save"></i> 保存
                                            </button>
                                            <a th:href="@{/merchant/products}" class="btn btn-default">
                                                <i class="fa fa-arrow-left"></i> 返回
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/assets/js/jquery.min.js}"></script>
    <script th:src="@{/back/js/bootstrap.js}"></script>
    <script>
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        
        $(document).ajaxSend(function(e, xhr, options) {
            xhr.setRequestHeader(header, token);
        });
        
        // 图片预览功能
        $('#productImg').on('input', function() {
            var imgUrl = $(this).val().trim();
            if (imgUrl) {
                $('#imagePreview').attr('src', imgUrl);
                $('#imagePreviewGroup').show();
                // 如果图片加载失败，隐藏预览
                $('#imagePreview').on('error', function() {
                    $(this).attr('src', '');
                    $('#imagePreviewGroup').hide();
                });
            } else {
                $('#imagePreviewGroup').hide();
            }
        });

        $('#productForm').submit(function(e) {
            e.preventDefault();
            
            // 表单验证
            if (!$('#productName').val().trim()) {
                alert('请输入菜品名称');
                return;
            }
            if (!$('#categoryId').val()) {
                alert('请选择菜品分类');
                return;
            }
            if (!$('#price').val() || parseFloat($('#price').val()) <= 0) {
                alert('请输入有效的价格');
                return;
            }
            if (!$('#stock').val() || parseInt($('#stock').val()) < 0) {
                alert('请输入有效的库存数量');
                return;
            }
            
            var product = {
                productId: $('#productId').val(),
                productName: $('#productName').val().trim(),
                categoryId: $('#categoryId').val(),
                productDesc: $('#productDesc').val().trim(),
                price: $('#price').val(),
                originalPrice: $('#originalPrice').val(),
                stock: $('#stock').val(),
                productImg: $('#productImg').val().trim(),
                status: $('#status').val(),
                isRecommend: $('#isRecommend').val()
            };
            
            // 调试：打印产品数据
            console.log('提交的更新数据:', product);
            console.log('JSON字符串:', JSON.stringify(product));
            
            $.ajax({
                url: '/merchant/product/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(product),
                success: function(result) {
                    console.log('服务器响应:', result);
                    if (result.success) {
                        alert('更新成功！');
                        window.location.href = '/merchant/products';
                    } else {
                        alert('更新失败：' + result.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX错误:', status, error);
                    console.error('响应内容:', xhr.responseText);
                    alert('更新失败，请重试。错误信息：' + error);
                }
            });
        });
    </script>
</body>
</html>
