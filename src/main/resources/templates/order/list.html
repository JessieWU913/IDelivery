<!DOCTYPE html>
<!-- ========================================
  è®¢å•åˆ—è¡¨é¡µé¢ï¼ˆç”¨æˆ·ç«¯ï¼‰
  ========================================
  åŠŸèƒ½ï¼š
  1. æ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„æ‰€æœ‰è®¢å•
  2. æŒ‰çŠ¶æ€ç­›é€‰è®¢å•ï¼ˆå…¨éƒ¨/å¾…æ”¯ä»˜/åˆ¶ä½œä¸­/é…é€ä¸­ç­‰ï¼‰
  3. è®¢å•æ“ä½œï¼ˆæ”¯ä»˜/å–æ¶ˆ/ç¡®è®¤æ”¶è´§ï¼‰
  4. è‡ªåŠ¨è½®è¯¢æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆ5ç§’ï¼‰
  
  æŠ€æœ¯æ ˆï¼š
  - Thymeleafï¼šæœåŠ¡ç«¯æ¨¡æ¿å¼•æ“ï¼ŒåŠ¨æ€æ¸²æŸ“æ•°æ®
  - jQueryï¼šç®€åŒ–AJAXå’ŒDOMæ“ä½œ
  - CSRFé˜²æŠ¤ï¼šé˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»
  ======================================== -->
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- CSRFä»¤ç‰Œï¼šSpring Securityå®‰å…¨æœºåˆ¶ï¼ŒPOSTè¯·æ±‚å¿…é¡»æºå¸¦ -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <title>æˆ‘çš„è®¢å• - å¤–å–ç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥CSSå’ŒJSåº“ -->
    <link rel="stylesheet" href="/assets/css/amazeui.min.css">
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/amazeui.min.js"></script>
    
    <!-- ======== é¡µé¢æ ·å¼ ======== -->
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .order-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }

        .page-title {
            font-size: 28px;
            color: #333;
            font-weight: bold;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 20px;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .filter-tab:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .order-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            transition: all 0.3s;
        }

        .order-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .order-info {
            flex: 1;
        }

        .order-no {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .order-time {
            font-size: 14px;
            color: #999;
        }

        .order-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-paid { background: #d1ecf1; color: #0c5460; }
        .status-preparing { background: #d4edda; color: #155724; }
        .status-delivering { background: #cce5ff; color: #004085; }
        .status-delivered { background: #fff3cd; color: #856404; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        .merchant-name {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .order-items {
            margin: 15px 0;
        }

        .order-item-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #666;
        }

        .order-item-row .item-name {
            flex: 1;
        }

        .order-item-row .item-quantity {
            margin: 0 20px;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .order-total {
            font-size: 18px;
            font-weight: bold;
            color: #ff6b6b;
        }

        .order-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .empty-orders {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-orders-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<!-- ======== ä¸»å®¹å™¨ ======== -->
<div class="order-container">
    <!-- ======== é¡µé¢å¤´éƒ¨ ======== -->
    <div class="page-header">
        <h1 class="page-title">ğŸ“¦ æˆ‘çš„è®¢å•</h1>
        <button class="btn btn-secondary" onclick="location.href='/menu/index'">ç»§ç»­è´­ç‰©</button>
    </div>

    <!-- ========================================
         è®¢å•çŠ¶æ€ç­›é€‰æ ‡ç­¾
         ========================================
         Thymeleafè¯­æ³•è¯´æ˜ï¼š
         - th:classappendï¼šåŠ¨æ€æ·»åŠ CSSç±»
         - ${status}ï¼šåç«¯ä¼ é€’çš„å½“å‰ç­›é€‰çŠ¶æ€
         - ç‚¹å‡»æ ‡ç­¾ â†’ è·³è½¬URL â†’ åç«¯é‡æ–°æŸ¥è¯¢ â†’ åˆ·æ–°é¡µé¢
         ======================================== -->
    <div class="filter-tabs">
        <!-- å…¨éƒ¨è®¢å• -->
        <div class="filter-tab" th:classappend="${status == null || status == ''} ? 'active'"
             onclick="location.href='/order/list'">å…¨éƒ¨</div>
        <!-- å¾…æ”¯ä»˜ï¼šç”¨æˆ·åˆšä¸‹å•ï¼Œæœªä»˜æ¬¾ -->
        <div class="filter-tab" th:classappend="${status == 'pending'} ? 'active'"
             onclick="location.href='/order/list?status=pending'">å¾…æ”¯ä»˜</div>
        <!-- å¾…æ¥å•ï¼šå·²ä»˜æ¬¾ï¼Œç­‰å¾…å•†å®¶æ¥å• -->
        <div class="filter-tab" th:classappend="${status == 'paid'} ? 'active'"
             onclick="location.href='/order/list?status=paid'">å¾…æ¥å•</div>
        <!-- åˆ¶ä½œä¸­ï¼šå•†å®¶å·²æ¥å•ï¼Œæ­£åœ¨åˆ¶ä½œ -->
        <div class="filter-tab" th:classappend="${status == 'preparing'} ? 'active'"
             onclick="location.href='/order/list?status=preparing'">åˆ¶ä½œä¸­</div>
        <!-- é…é€ä¸­ï¼šå•†å®¶å·²å‡ºé¤ï¼Œéª‘æ‰‹é…é€ -->
        <div class="filter-tab" th:classappend="${status == 'delivering'} ? 'active'"
             onclick="location.href='/order/list?status=delivering'">é…é€ä¸­</div>
        <!-- å¾…ç¡®è®¤æ”¶è´§ï¼šéª‘æ‰‹å·²é€è¾¾ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤ -->
        <div class="filter-tab" th:classappend="${status == 'delivered'} ? 'active'"
             onclick="location.href='/order/list?status=delivered'">å¾…ç¡®è®¤æ”¶è´§</div>
        <!-- å·²å®Œæˆï¼šç”¨æˆ·å·²ç¡®è®¤æ”¶è´§ -->
        <div class="filter-tab" th:classappend="${status == 'completed'} ? 'active'"
             onclick="location.href='/order/list?status=completed'">å·²å®Œæˆ</div>
        <!-- å·²å–æ¶ˆï¼šç”¨æˆ·å–æ¶ˆè®¢å• -->
        <div class="filter-tab" th:classappend="${status == 'cancelled'} ? 'active'"
             onclick="location.href='/order/list?status=cancelled'">å·²å–æ¶ˆ</div>
    </div>

    <!-- ========================================
         è®¢å•åˆ—è¡¨åŒºåŸŸ
         ========================================
         Thymeleafæ¡ä»¶æ¸²æŸ“ï¼š
         - th:ifï¼šæ¡ä»¶ä¸ºtrueæ—¶æ‰æ¸²æŸ“æ­¤å…ƒç´ 
         - th:eachï¼šå¾ªç¯éå†é›†åˆ
         ======================================== -->
    
    <!-- ã€æƒ…å†µ1ï¼šè®¢å•åˆ—è¡¨ä¸ºç©ºã€‘ -->
    <div th:if="${orders == null || orders.size() == 0}" class="empty-orders">
        <div class="empty-orders-icon">ğŸ“¦</div>
        <h3>æš‚æ— è®¢å•</h3>
        <p>å¿«å»é€‰è´­æ‚¨å–œæ¬¢çš„å•†å“å§~</p>
        <button class="btn btn-primary" style="margin-top: 20px;" onclick="location.href='/menu/index'">å»è´­ç‰©</button>
    </div>

    <!-- ã€æƒ…å†µ2ï¼šæœ‰è®¢å•æ•°æ®ã€‘ -->
    <div th:if="${orders != null && orders.size() > 0}">
        <!-- å¾ªç¯æ¸²æŸ“æ¯ä¸ªè®¢å• -->
        <!-- th:each="order : ${orders}" â†’ ç±»ä¼¼Javaçš„ for(Order order : orders) -->
        <!-- th:attr="data-order-id=${order.orderId}" â†’ è®¾ç½®è‡ªå®šä¹‰å±æ€§ï¼Œç”¨äºè½®è¯¢æœºåˆ¶ -->
        <div th:each="order : ${orders}" class="order-item order-card" th:attr="data-order-id=${order.orderId}">
            
            <!-- ======== è®¢å•å¤´éƒ¨ï¼šè®¢å•å·ã€æ—¶é—´ã€çŠ¶æ€ ======== -->
            <div class="order-header">
                <div class="order-info">
                    <!-- è®¢å•å· -->
                    <div class="order-no">è®¢å•å·ï¼š<span th:text="${order.orderNo}">ORDER123456</span></div>
                    <!-- ä¸‹å•æ—¶é—´ï¼š#temporalsæ˜¯Thymeleafæ—¥æœŸæ ¼å¼åŒ–å·¥å…· -->
                    <div class="order-time" th:text="${#temporals.format(order.createTime, 'yyyy-MM-dd HH:mm:ss')}">2025-11-10 12:00:00</div>
                </div>
                <div>
                    <!-- è®¢å•çŠ¶æ€æ ‡ç­¾ï¼šæ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒé¢œè‰² -->
                    <!-- th:classappendåŠ¨æ€æ·»åŠ çŠ¶æ€æ ·å¼ç±»ï¼ˆstatus-pendingã€status-paidç­‰ï¼‰ -->
                    <span class="order-status" th:classappend="'status-' + ${order.orderStatus}">
                        <!-- th:switchç±»ä¼¼Javaçš„switchè¯­å¥ -->
                        <span th:switch="${order.orderStatus}">
                            <span th:case="'pending'">å¾…æ”¯ä»˜</span>
                            <span th:case="'paid'">å¾…æ¥å•</span>
                            <span th:case="'preparing'">åˆ¶ä½œä¸­</span>
                            <span th:case="'delivering'">é…é€ä¸­</span>
                            <span th:case="'delivered'">å¾…ç¡®è®¤æ”¶è´§</span>
                            <span th:case="'completed'">å·²å®Œæˆ</span>
                            <span th:case="'cancelled'">å·²å–æ¶ˆ</span>
                        </span>
                    </span>
                </div>
            </div>

            <!-- ======== å•†æˆ·åç§° ======== -->
            <div class="merchant-name">ğŸª <span th:text="${order.merchantName}">å•†æˆ·åç§°</span></div>

            <!-- ======== è®¢å•å•†å“åˆ—è¡¨ ======== -->
            <div class="order-items" th:if="${order.orderItems != null && order.orderItems.size() > 0}">
                <!-- å¾ªç¯æ¸²æŸ“æ¯ä¸ªå•†å“ -->
                <div th:each="item : ${order.orderItems}" class="order-item-row">
                    <span class="item-name" th:text="${item.productName}">å•†å“åç§°</span>
                    <span class="item-quantity">x<span th:text="${item.quantity}">1</span></span>
                    <!-- #numbers.formatDecimal(æ•°å€¼, æ•´æ•°ä½, å°æ•°ä½) â†’ æ ¼å¼åŒ–é‡‘é¢ -->
                    <span>Â¥<span th:text="${#numbers.formatDecimal(item.subtotal, 1, 2)}">0.00</span></span>
                </div>
            </div>

            <!-- ======== è®¢å•åº•éƒ¨ï¼šæ€»ä»·ã€æ“ä½œæŒ‰é’® ======== -->
            <div class="order-footer">
                <!-- å®ä»˜é‡‘é¢ -->
                <div class="order-total">
                    å®ä»˜ï¼šÂ¥<span th:text="${#numbers.formatDecimal(order.actualAmount, 1, 2)}">0.00</span>
                </div>
                
                <!-- æ“ä½œæŒ‰é’®ï¼šæ ¹æ®è®¢å•çŠ¶æ€åŠ¨æ€æ˜¾ç¤º -->
                <div class="order-actions">
                    <!-- æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®ï¼ˆæ‰€æœ‰è®¢å•éƒ½æ˜¾ç¤ºï¼‰ -->
                    <button class="btn btn-secondary"
                            th:onclick="'location.href=\'/order/detail/' + ${order.orderId} + '\''">æŸ¥çœ‹è¯¦æƒ…</button>
                    
                    <!-- ç«‹å³æ”¯ä»˜æŒ‰é’®ï¼ˆä»…å¾…æ”¯ä»˜è®¢å•æ˜¾ç¤ºï¼‰ -->
                    <button th:if="${order.orderStatus == 'pending'}"
                            class="btn btn-primary"
                            th:onclick="'payOrder(' + ${order.orderId} + ')'">ç«‹å³æ”¯ä»˜</button>
                    
                    <!-- å–æ¶ˆè®¢å•æŒ‰é’®ï¼ˆä»…å¾…æ”¯ä»˜è®¢å•æ˜¾ç¤ºï¼‰ -->
                    <button th:if="${order.orderStatus == 'pending'}"
                            class="btn btn-danger"
                            th:onclick="'cancelOrder(' + ${order.orderId} + ')'">å–æ¶ˆè®¢å•</button>
                    
                    <!-- ç¡®è®¤æ”¶è´§æŒ‰é’®ï¼ˆä»…å·²é€è¾¾è®¢å•æ˜¾ç¤ºï¼‰ -->
                    <button th:if="${order.orderStatus == 'delivered'}"
                            class="btn btn-primary"
                            th:onclick="'confirmOrder(' + ${order.orderId} + ')'">ç¡®è®¤æ”¶è´§</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================
     JavaScriptä¸šåŠ¡é€»è¾‘
     ========================================
     åŠŸèƒ½ï¼š
     1. CSRFä»¤ç‰Œè‡ªåŠ¨æ·»åŠ ï¼ˆå®‰å…¨é˜²æŠ¤ï¼‰
     2. è®¢å•æ“ä½œå‡½æ•°ï¼ˆæ”¯ä»˜/å–æ¶ˆ/ç¡®è®¤æ”¶è´§ï¼‰
     3. è½®è¯¢æœºåˆ¶ï¼ˆè‡ªåŠ¨æ›´æ–°è®¢å•çŠ¶æ€ï¼‰
     ======================================== -->
<script>
    // ========================================
    // 1. CSRFå®‰å…¨é…ç½®
    // ========================================
    // Spring Securityè¦æ±‚æ‰€æœ‰POSTè¯·æ±‚å¿…é¡»æºå¸¦CSRFä»¤ç‰Œ
    // ä»metaæ ‡ç­¾ä¸­è¯»å–ä»¤ç‰Œï¼Œè‡ªåŠ¨æ·»åŠ åˆ°æ‰€æœ‰AJAXè¯·æ±‚å¤´ä¸­
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    $(document).ajaxSend(function(e, xhr, options) {
        xhr.setRequestHeader(header, token); // è®¾ç½®è¯·æ±‚å¤´
    });

    // ========================================
    // 2. è®¢å•æ“ä½œå‡½æ•°
    // ========================================
    
    /**
     * æ”¯ä»˜è®¢å•
     * æµç¨‹ï¼šç¡®è®¤ â†’ å‘é€POSTè¯·æ±‚ â†’ åç«¯å¤„ç† â†’ åˆ·æ–°é¡µé¢
     */
    function payOrder(orderId) {
        if (!confirm('ç¡®è®¤æ”¯ä»˜æ­¤è®¢å•å—ï¼Ÿ')) return; // ç”¨æˆ·ç¡®è®¤
        
        $.ajax({
            url: '/order/pay/' + orderId,  // åç«¯æ¥å£
            type: 'POST',                  // POSTè¯·æ±‚
            success: function(res) {
                if (res.success) {
                    alert('æ”¯ä»˜æˆåŠŸï¼');
                    location.reload();     // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
                } else {
                    alert(res.message || 'æ”¯ä»˜å¤±è´¥');
                }
            }
        });
    }

    /**
     * å–æ¶ˆè®¢å•
     * æµç¨‹ï¼šè¾“å…¥å–æ¶ˆåŸå›  â†’ ç¡®è®¤ â†’ å‘é€POSTè¯·æ±‚ â†’ æ¢å¤åº“å­˜ â†’ åˆ·æ–°é¡µé¢
     */
    function cancelOrder(orderId) {
        const reason = prompt('è¯·è¾“å…¥å–æ¶ˆåŸå› ï¼ˆé€‰å¡«ï¼‰ï¼š'); // å¼¹å‡ºè¾“å…¥æ¡†
        if (reason === null) return; // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆæŒ‰é’®
        
        if (!confirm('ç¡®è®¤å–æ¶ˆæ­¤è®¢å•å—ï¼Ÿ')) return;
        
        $.ajax({
            url: '/order/cancel/' + orderId,
            type: 'POST',
            data: { cancelReason: reason || 'ç”¨æˆ·å–æ¶ˆ' }, // å‘é€å–æ¶ˆåŸå› 
            success: function(res) {
                if (res.success) {
                    alert('è®¢å•å·²å–æ¶ˆ');
                    location.reload();
                } else {
                    alert(res.message || 'å–æ¶ˆå¤±è´¥');
                }
            }
        });
    }

    /**
     * ç¡®è®¤æ”¶è´§
     * æµç¨‹ï¼šç¡®è®¤ â†’ å‘é€POSTè¯·æ±‚ â†’ æ›´æ–°é”€é‡ â†’ å®Œæˆè®¢å• â†’ åˆ·æ–°é¡µé¢
     */
    function confirmOrder(orderId) {
        if (!confirm('ç¡®è®¤å·²æ”¶åˆ°å•†å“å—ï¼Ÿ')) return;
        
        $.ajax({
            url: '/order/confirm/' + orderId,
            type: 'POST',
            success: function(res) {
                if (res.success) {
                    alert('ç¡®è®¤æ”¶è´§æˆåŠŸï¼');
                    location.reload();
                } else {
                    alert(res.message || 'æ“ä½œå¤±è´¥');
                }
            }
        });
    }
    
    // ========================================
    // è½®è¯¢æœºåˆ¶ï¼šè‡ªåŠ¨åˆ·æ–°è®¢å•çŠ¶æ€
    // ========================================
    // 
    // ã€åŠŸèƒ½è¯´æ˜ã€‘
    // ç”¨æˆ·åœ¨è®¢å•åˆ—è¡¨é¡µé¢æ—¶ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°ï¼Œç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹è®¢å•çŠ¶æ€å˜åŒ–
    // å½“è®¢å•çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼ˆå¦‚ï¼šå•†å®¶æ¥å•ã€éª‘æ‰‹é…é€ï¼‰ï¼Œè‡ªåŠ¨åˆ·æ–°é¡µé¢
    // 
    // ã€å®ç°åŸç†ã€‘
    // 1. ä½¿ç”¨ setInterval æ¯5ç§’å‘åç«¯å‘é€ä¸€æ¬¡AJAXè¯·æ±‚
    // 2. åç«¯æŸ¥è¯¢è®¢å•çš„æœ€æ–°çŠ¶æ€å¹¶è¿”å›
    // 3. å‰ç«¯å¯¹æ¯”çŠ¶æ€ï¼Œå‘ç°å˜åŒ–åˆ™åˆ·æ–°é¡µé¢
    // 
    // ã€æŠ€æœ¯è¦ç‚¹ã€‘
    // - setIntervalï¼šJavaScriptå®šæ—¶å™¨ï¼Œå‘¨æœŸæ€§æ‰§è¡Œå‡½æ•°
    // - AJAXè½®è¯¢ï¼šå®šæœŸè¯·æ±‚æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®
    // - DOMæ“ä½œï¼šé€šè¿‡data-order-idå±æ€§å®šä½è®¢å•å…ƒç´ 
    // - èµ„æºç®¡ç†ï¼šé¡µé¢å…³é—­æ—¶æ¸…ç†å®šæ—¶å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼
    // 
    // ã€åº”ç”¨åœºæ™¯ã€‘
    // - ç”¨æˆ·ä¸‹å•æ”¯ä»˜åï¼Œç­‰å¾…å•†å®¶æ¥å•ï¼ˆçŠ¶æ€ä» pending â†’ paid â†’ preparingï¼‰
    // - å•†å®¶åˆ¶ä½œå®Œæˆåï¼Œç­‰å¾…éª‘æ‰‹é…é€ï¼ˆçŠ¶æ€ä» preparing â†’ deliveringï¼‰
    // - éª‘æ‰‹é€è¾¾åï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤æ”¶è´§ï¼ˆçŠ¶æ€ä» delivering â†’ delivered â†’ completedï¼‰
    // 
    // ========================================
    
    let pollInterval; // è½®è¯¢å®šæ—¶å™¨ï¼ˆå…¨å±€å˜é‡ï¼Œç”¨äºåç»­æ¸…ç†ï¼‰
    
    /**
     * å¯åŠ¨è½®è¯¢æœºåˆ¶
     * æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡è®¢å•çŠ¶æ€æ˜¯å¦æœ‰å˜åŒ–
     */
    function startPolling() {
        // ---------- æ­¥éª¤1ï¼šæ”¶é›†é¡µé¢ä¸Šæ‰€æœ‰è®¢å•ID ----------
        // æŠ€æœ¯è¯´æ˜ï¼š
        // - querySelectorAll('.order-card')ï¼šæŸ¥æ‰¾æ‰€æœ‰è®¢å•å¡ç‰‡å…ƒç´ 
        // - getAttribute('data-order-id')ï¼šè·å–è®¢å•IDï¼ˆåœ¨Thymeleafæ¨¡æ¿ä¸­é€šè¿‡ th:attr è®¾ç½®ï¼‰
        // - ç¤ºä¾‹HTMLï¼š<div class="order-card" data-order-id="123">...</div>
        const orderIds = [];
        document.querySelectorAll('.order-card').forEach(card => {
            const orderId = card.getAttribute('data-order-id');
            if (orderId) orderIds.push(orderId);
        });
        
        // å¦‚æœé¡µé¢æ²¡æœ‰è®¢å•ï¼Œåˆ™ä¸å¯åŠ¨è½®è¯¢ï¼ˆä¼˜åŒ–ï¼šé¿å…æ— æ„ä¹‰çš„è¯·æ±‚ï¼‰
        if (orderIds.length === 0) return;
        
        // ---------- æ­¥éª¤2ï¼šè®¾ç½®å®šæ—¶å™¨ï¼Œæ¯5ç§’æ‰§è¡Œä¸€æ¬¡ ----------
        // setInterval(å‡½æ•°, æ—¶é—´é—´éš”æ¯«ç§’)
        // 5000æ¯«ç§’ = 5ç§’
        pollInterval = setInterval(() => {
            // ---------- æ­¥éª¤3ï¼šå‘é€AJAXè¯·æ±‚åˆ°åç«¯ ----------
            $.ajax({
                url: '/order/checkUpdates',              // åç«¯æ¥å£åœ°å€
                type: 'GET',                             // HTTPæ–¹æ³•ï¼šGET
                data: { orderIds: orderIds.join(',') }, // å‚æ•°ï¼šè®¢å•IDåˆ—è¡¨ï¼Œé€—å·åˆ†éš”ï¼ˆå¦‚ï¼š"123,456,789"ï¼‰
                
                // ---------- æ­¥éª¤4ï¼šå¤„ç†åç«¯å“åº” ----------
                success: function(res) {
                    // ã€æƒ…å†µ1ï¼šç™»å½•å·²è¿‡æœŸã€‘
                    // åç«¯æ£€æµ‹åˆ°Sessionå¤±æ•ˆæ—¶ï¼Œè¿”å› needLogin: true
                    if (res.needLogin) {
                        clearInterval(pollInterval); // åœæ­¢è½®è¯¢ï¼ˆé‡è¦ï¼šé¿å…ç»§ç»­å‘é€æ— æ•ˆè¯·æ±‚ï¼‰
                        return;                      // æå‰è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­é€»è¾‘
                    }
                    
                    // ã€æƒ…å†µ2ï¼šæˆåŠŸè·å–è®¢å•çŠ¶æ€æ›´æ–°ã€‘
                    if (res.success && res.updates) {
                        let hasChange = false; // æ ‡å¿—ä½ï¼šæ˜¯å¦æœ‰çŠ¶æ€å˜åŒ–
                        
                        // éå†æ‰€æœ‰è®¢å•çš„æœ€æ–°çŠ¶æ€
                        res.updates.forEach(update => {
                            // æ‰¾åˆ°é¡µé¢ä¸Šå¯¹åº”è®¢å•çš„çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
                            // ç¤ºä¾‹ï¼š<span class="order-status">å¾…æ”¯ä»˜</span>
                            const statusSpan = document.querySelector(`[data-order-id="${update.orderId}"] .order-status`);
                            
                            // å¯¹æ¯”çŠ¶æ€æ–‡æœ¬æ˜¯å¦å˜åŒ–
                            // æ—§çŠ¶æ€ï¼š"å¾…æ”¯ä»˜"  vs  æ–°çŠ¶æ€ï¼š"å·²æ”¯ä»˜" â†’ å‘ç°å˜åŒ–
                            if (statusSpan && statusSpan.innerText !== update.statusText) {
                                hasChange = true; // æ ‡è®°æœ‰å˜åŒ–
                            }
                        });
                        
                        // ---------- æ­¥éª¤5ï¼šæ£€æµ‹åˆ°çŠ¶æ€å˜åŒ–ï¼Œåˆ·æ–°é¡µé¢ ----------
                        // ä¸ºä»€ä¹ˆåˆ·æ–°é¡µé¢ï¼Ÿ
                        // - ä¸ä»…çŠ¶æ€æ–‡æœ¬è¦æ›´æ–°ï¼Œè®¢å•å¡ç‰‡çš„æ ·å¼ã€æ“ä½œæŒ‰é’®ä¹Ÿè¦å˜åŒ–
                        // - åˆ·æ–°é¡µé¢æ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼ˆä¹Ÿå¯ä»¥ç”¨å±€éƒ¨DOMæ›´æ–°ï¼Œä½†ä»£ç å¤æ‚ï¼‰
                        if (hasChange) {
                            location.reload(); // åˆ·æ–°å½“å‰é¡µé¢
                        }
                    }
                }
            });
        }, 5000); // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡ï¼ˆè½®è¯¢é—´éš”ï¼‰
        
        // ã€ä¸ºä»€ä¹ˆæ˜¯5ç§’ï¼Ÿã€‘
        // - å¤ªå¿«ï¼ˆå¦‚1ç§’ï¼‰ï¼šæœåŠ¡å™¨å‹åŠ›å¤§ï¼Œç”¨æˆ·ä½“éªŒæå‡ä¸æ˜æ˜¾
        // - å¤ªæ…¢ï¼ˆå¦‚30ç§’ï¼‰ï¼šç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿ï¼Œä½“éªŒå·®
        // - 5ç§’æ˜¯ç»éªŒå€¼ï¼šå…¼é¡¾å®æ—¶æ€§å’ŒæœåŠ¡å™¨å‹åŠ›
    }
    
    // ========================================
    // ç”Ÿå‘½å‘¨æœŸç®¡ç†
    // ========================================
    
    // ã€é¡µé¢åŠ è½½å®Œæˆæ—¶ã€‘å¯åŠ¨è½®è¯¢
    // $(document).ready() ç¡®ä¿DOMå…ƒç´ éƒ½å·²åŠ è½½å®Œæ¯•
    $(document).ready(function() {
        startPolling(); // å¯åŠ¨è½®è¯¢æœºåˆ¶
    });
    
    // ã€é¡µé¢å…³é—­æ—¶ã€‘åœæ­¢è½®è¯¢ï¼ˆé‡è¦ï¼šé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
    // beforeunloadï¼šç”¨æˆ·å…³é—­æ ‡ç­¾é¡µæˆ–ç¦»å¼€é¡µé¢æ—¶è§¦å‘
    window.addEventListener('beforeunload', function() {
        if (pollInterval) {
            clearInterval(pollInterval); // æ¸…é™¤å®šæ—¶å™¨
        }
        // ä¸ºä»€ä¹ˆè¦æ¸…é™¤ï¼Ÿ
        // - å®šæ—¶å™¨ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œä¼šæŒç»­å ç”¨å†…å­˜
        // - ç”¨æˆ·ç¦»å¼€é¡µé¢åï¼Œç»§ç»­è½®è¯¢æ²¡æœ‰æ„ä¹‰
        // - å¦‚æœä¸æ¸…é™¤ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
    });
</script>
</body>
</html>

