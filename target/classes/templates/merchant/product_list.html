<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>菜品管理</title>
    
    <link rel="stylesheet" th:href="@{/back/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/back/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/back/css/style.min.css}">
</head>
<body>
    <div id="wrapper">
        <div id="page-wrapper" class="gray-bg">
            <div class="row wrapper border-bottom white-bg page-heading">
                <div class="col-lg-10">
                    <h2>菜品管理</h2>
                    <ol class="breadcrumb">
                        <li><a th:href="@{/merchant/index}">商户中心</a></li>
                        <li class="active">菜品管理</li>
                    </ol>
                </div>
            </div>

            <div class="wrapper wrapper-content">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox">
                            <div class="ibox-title">
                                <h5>菜品列表</h5>
                                <div class="ibox-tools">
                                    <a th:href="@{/merchant/product/add}" class="btn btn-primary btn-sm">
                                        <i class="fa fa-plus"></i> 添加菜品
                                    </a>
                                </div>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>图片</th>
                                            <th>菜品名称</th>
                                            <th>分类</th>
                                            <th>价格</th>
                                            <th>库存</th>
                                            <th>销量</th>
                                            <th>推荐</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="product : ${products}">
                                            <td th:text="${product.productId}">1</td>
                                            <td>
                                                <img th:src="${product.productImg}" alt="菜品图片" 
                                                     style="width: 50px; height: 50px; object-fit: cover;" 
                                                     onerror="this.src='/img/product/default.jpg'">
                                            </td>
                                            <td th:text="${product.productName}">菜品名</td>
                                            <td th:text="${product.categoryName}">分类</td>
                                            <td>¥<span th:text="${product.price}">0</span></td>
                                            <td th:text="${product.stock}">0</td>
                                            <td th:text="${product.sales}">0</td>
                                            <td>
                                                <span class="label" 
                                                      th:classappend="${product.isRecommend == '1'} ? 'label-success' : 'label-default'"
                                                      th:text="${product.isRecommend == '1'} ? '是' : '否'">否</span>
                                            </td>
                                            <td>
                                                <span class="label" 
                                                      th:classappend="${product.status == '1'} ? 'label-primary' : 'label-default'"
                                                      th:text="${product.status == '1'} ? '上架' : '下架'">上架</span>
                                            </td>
                                            <td>
                                                <a th:href="@{/merchant/product/edit/{id}(id=${product.productId})}" 
                                                   class="btn btn-xs btn-info">
                                                    <i class="fa fa-edit"></i> 编辑
                                                </a>
                                                <button class="btn btn-xs btn-danger" 
                                                        th:onclick="'deleteProduct(' + ${product.productId} + ')'">
                                                    <i class="fa fa-trash"></i> 删除
                                                </button>
                                            </td>
                                        </tr>
                                        <tr th:if="${#lists.isEmpty(products)}">
                                            <td colspan="10" style="text-align: center; color: #999; padding: 30px;">
                                                暂无菜品，<a th:href="@{/merchant/product/add}">点击添加</a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/assets/js/jquery.min.js}"></script>
    <script th:src="@{/back/js/bootstrap.js}"></script>
    <script>
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        
        $(document).ajaxSend(function(e, xhr, options) {
            xhr.setRequestHeader(header, token);
        });

        function deleteProduct(productId) {
            console.log('尝试删除菜品ID:', productId);
            if (confirm('确定要删除这个菜品吗？删除后无法恢复！')) {
                $.ajax({
                    url: '/merchant/product/delete/' + productId,
                    type: 'POST',
                    success: function(result) {
                        console.log('删除响应:', result);
                        if (result.success) {
                            alert('删除成功');
                            location.reload();
                        } else {
                            alert('删除失败：' + result.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('删除AJAX错误:', status, error);
                        console.error('响应内容:', xhr.responseText);
                        alert('删除失败，请重试。错误信息：' + error);
                    }
                });
            }
        }
    </script>
</body>
</html>
