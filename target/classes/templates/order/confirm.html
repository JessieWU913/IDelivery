<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>è®¢å•ç¡®è®¤ - å¤–å–ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/assets/css/amazeui.min.css">
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/amazeui.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .confirm-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }

        .page-title {
            font-size: 28px;
            color: #333;
            font-weight: bold;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .address-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .address-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .address-item.selected {
            border-color: #667eea;
            background: #e8f0ff;
        }

        .address-item .default-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .cart-summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-row.total {
            border-bottom: none;
            border-top: 2px solid #667eea;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #ff6b6b;
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-back {
            background: #ccc;
            color: white;
        }

        .btn-back:hover {
            background: #aaa;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
            margin-left: 15px;
        }

        .btn-submit:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
<div class="confirm-container">
    <div class="page-header">
        <h1 class="page-title">è®¢å•ç¡®è®¤</h1>
        <button class="btn btn-back" onclick="history.back()">è¿”å›è´­ç‰©è½¦</button>
    </div>

    <!-- é…é€åœ°å€ -->
    <div class="section">
        <div class="section-title">é€‰æ‹©é…é€åœ°å€</div>
        <div id="addressList">
            <div th:if="${addresses != null && addresses.size() > 0}">
                <div th:each="addr : ${addresses}"
                     class="address-item"
                     th:onclick="'selectAddress(' + ${addr.addressId} + ')'"
                     th:attr="data-address-id=${addr.addressId}">
                    <div>
                        <strong th:text="${addr.contactName}">è”ç³»äºº</strong>
                        <span th:text="${addr.contactPhone}">è”ç³»ç”µè¯</span>
                        <span th:if="${addr.isDefault == '1'}" class="default-badge">é»˜è®¤</span>
                    </div>
                    <div style="margin-top: 5px; color: #666;" th:text="${addr.fullAddress != null ? addr.fullAddress : addr.detailAddress}">åœ°å€</div>
                </div>
            </div>
            <div class="address-item" onclick="showNewAddressForm()">
                <div>
                    <strong>+ æ–°å¢åœ°å€</strong>
                    <span style="color: #999; margin-left: 10px;">ç‚¹å‡»æ·»åŠ æ–°åœ°å€</span>
                </div>
            </div>
        </div>
        <div id="newAddressForm" style="display: none; margin-top: 20px;">
            <div class="form-group">
                <label>è”ç³»äººå§“å *</label>
                <input type="text" id="contactName" placeholder="è¯·è¾“å…¥è”ç³»äººå§“å" required>
            </div>
            <div class="form-group">
                <label>è”ç³»ç”µè¯ *</label>
                <input type="tel" id="contactPhone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" required>
            </div>
            <div class="form-group">
                <label>çœä»½</label>
                <input type="text" id="province" placeholder="è¯·è¾“å…¥çœä»½">
            </div>
            <div class="form-group">
                <label>åŸå¸‚</label>
                <input type="text" id="city" placeholder="è¯·è¾“å…¥åŸå¸‚">
            </div>
            <div class="form-group">
                <label>åŒºå¿</label>
                <input type="text" id="district" placeholder="è¯·è¾“å…¥åŒºå¿">
            </div>
            <div class="form-group">
                <label>è¯¦ç»†åœ°å€ *</label>
                <input type="text" id="detailAddress" placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€" required>
            </div>
            <button class="btn btn-submit" onclick="saveNewAddress()">ä¿å­˜åœ°å€</button>
        </div>
    </div>

    <!-- è®¢å•ä¿¡æ¯ -->
    <div class="section">
        <div class="section-title">è®¢å•ä¿¡æ¯</div>
        <div class="form-group">
            <label>è®¢å•å¤‡æ³¨</label>
            <textarea id="remark" placeholder="é€‰å¡«ï¼šå¦‚æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œè¯·åœ¨æ­¤å¡«å†™"></textarea>
        </div>
    </div>

    <!-- è®¢å•æ±‡æ€» -->
    <div class="cart-summary">
        <div class="section-title">è®¢å•æ±‡æ€»</div>
        <div th:if="${cartList != null && cartList.size() > 0}">
            <!-- æŒ‰å•†æˆ·åˆ†ç»„æ˜¾ç¤º -->
            <div th:each="merchantEntry : ${cartByMerchant}" style="margin-bottom: 20px;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 10px;">
                    ğŸª <span th:text="${#strings.substringAfter(merchantEntry.key, '_')}">å•†æˆ·åç§°</span>
                </div>
                <div th:each="item : ${merchantEntry.value}" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span th:text="${item.productName}">å•†å“åç§°</span>
                    <span>x<span th:text="${item.quantity}">1</span></span>
                    <span>Â¥<span th:text="${#numbers.formatDecimal(item.price * item.quantity, 1, 2)}">0.00</span></span>
                </div>
            </div>
            <div class="summary-row total">
                <span>åˆè®¡ï¼š</span>
                <span>Â¥<span th:text="${#numbers.formatDecimal(totalPrice, 1, 2)}">0.00</span></span>
            </div>
        </div>
    </div>

    <!-- æäº¤æŒ‰é’® -->
    <div class="btn-group">
        <button class="btn btn-back" onclick="history.back()">è¿”å›ä¿®æ”¹</button>
        <button class="btn btn-submit" id="submitBtn" onclick="submitOrder()" disabled>æäº¤è®¢å•</button>
    </div>
</div>

<script>
    let selectedAddress = null;

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    $(document).ready(function() {
        // è‡ªåŠ¨é€‰ä¸­é»˜è®¤åœ°å€
        const defaultAddress = $('.address-item .default-badge').closest('.address-item');
        if (defaultAddress.length > 0) {
            const addressId = defaultAddress.attr('data-address-id');
            if (addressId) {
                selectAddress(parseInt(addressId));
            }
        }
        updateSubmitButton();
    });

    // æ˜¾ç¤ºæ–°å¢åœ°å€è¡¨å•
    function showNewAddressForm() {
        $('#newAddressForm').show();
        $('.address-item').removeClass('selected');
        selectedAddress = null;
        updateSubmitButton();
    }

    // é€‰æ‹©åœ°å€
    function selectAddress(addressId) {
        // éšè—æ–°å¢åœ°å€è¡¨å•
        $('#newAddressForm').hide();

        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        $('.address-item').removeClass('selected');
        const addressElement = $('.address-item[data-address-id="' + addressId + '"]');
        addressElement.addClass('selected');

        // ä»é¡µé¢ä¸­è·å–åœ°å€ä¿¡æ¯
        if (addressElement.length > 0) {
            const nameText = addressElement.find('strong').text().trim();
            const phoneText = addressElement.find('strong').next('span').text().trim();
            const addressText = addressElement.find('div').last().text().trim();

            selectedAddress = {
                addressId: addressId,
                contactName: nameText,
                contactPhone: phoneText,
                fullAddress: addressText
            };
            updateSubmitButton();
        }
    }

    // ä¿å­˜æ–°åœ°å€
    function saveNewAddress() {
        const address = {
            contactName: $('#contactName').val(),
            contactPhone: $('#contactPhone').val(),
            province: $('#province').val(),
            city: $('#city').val(),
            district: $('#district').val(),
            detailAddress: $('#detailAddress').val(),
            isDefault: '0'
        };

        if (!address.contactName || !address.contactPhone || !address.detailAddress) {
            alert('è¯·å¡«å†™å¿…å¡«é¡¹');
            return;
        }

        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: '/address/add',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(address),
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token); // æ·»åŠ  CSRF Token
            },
            success: function(res) {
                if (res.success) {
                    alert('åœ°å€æ·»åŠ æˆåŠŸ');
                    // åˆ·æ–°åœ°å€åˆ—è¡¨
                    loadAddressList();
                } else {
                    alert(res.message || 'æ·»åŠ å¤±è´¥');
                }
            },
            error: function(xhr) {
                console.error('é”™è¯¯è¯¦æƒ…:', xhr.responseText); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        });
    }

    // åŠ è½½åœ°å€åˆ—è¡¨
    function loadAddressList() {
        $.ajax({
            url: '/address/listByUser',
            type: 'GET',
            success: function(res) {
                if (res.success) {
                    const addressList = res.addresses;
                    const addressListContainer = $('#addressList');
                    addressListContainer.empty();

                    // æ¸²æŸ“åœ°å€åˆ—è¡¨
                    addressList.forEach(addr => {
                        const isDefault = addr.isDefault === '1';
                        const addressItem = `
                                <div class="address-item ${isDefault ? 'selected' : ''}"
                                     data-address-id="${addr.addressId}"
                                     onclick="selectAddress(${addr.addressId})">
                                    <div>
                                        <strong>${addr.contactName}</strong>
                                        <span>${addr.contactPhone}</span>
                                        ${isDefault ? '<span class="default-badge">é»˜è®¤</span>' : ''}
                                    </div>
                                    <div style="margin-top: 5px; color: #666;">${addr.fullAddress || addr.detailAddress}</div>
                                </div>
                            `;
                        addressListContainer.append(addressItem);
                    });

                    // æ·»åŠ æ–°å¢åœ°å€æŒ‰é’®
                    addressListContainer.append(`
                            <div class="address-item" onclick="showNewAddressForm()">
                                <div>
                                    <strong>+ æ–°å¢åœ°å€</strong>
                                    <span style="color: #999; margin-left: 10px;">ç‚¹å‡»æ·»åŠ æ–°åœ°å€</span>
                                </div>
                            </div>
                        `);

                    // è‡ªåŠ¨é€‰ä¸­é»˜è®¤åœ°å€
                    const defaultAddress = $('.address-item .default-badge').closest('.address-item');
                    if (defaultAddress.length > 0) {
                        const addressId = defaultAddress.attr('data-address-id');
                        if (addressId) {
                            selectAddress(parseInt(addressId));
                        }
                    }
                } else {
                    alert(res.message || 'åŠ è½½åœ°å€å¤±è´¥');
                }
            },
            error: function() {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        });
    }

    // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
    function updateSubmitButton() {
        if (selectedAddress) {
            $('#submitBtn').prop('disabled', false);
        } else {
            $('#submitBtn').prop('disabled', true);
        }
    }

    // æäº¤è®¢å•
    function submitOrder() {
        if (!selectedAddress) {
            alert('è¯·é€‰æ‹©é…é€åœ°å€');
            return;
        }

        const deliveryAddress = selectedAddress.fullAddress;
        const contactName = selectedAddress.contactName;
        const contactPhone = selectedAddress.contactPhone;
        const remark = $('#remark').val() || '';

        if (!deliveryAddress || !contactName || !contactPhone) {
            alert('åœ°å€ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·é‡æ–°é€‰æ‹©');
            return;
        }

        if (!confirm('ç¡®è®¤æäº¤è®¢å•å—ï¼Ÿ')) {
            return;
        }

        $('#submitBtn').prop('disabled', true).text('æäº¤ä¸­...');

        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: '/order/create',
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded', // ç¡®ä¿ä¸åç«¯æ¥æ”¶æ ¼å¼ä¸€è‡´
            data: {
                deliveryAddress: deliveryAddress,
                contactName: contactName,
                contactPhone: contactPhone,
                remark: remark
            },
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token); // æ·»åŠ  CSRF Token
            },
            success: function(res) {
                if (res.success) {
                    alert('è®¢å•åˆ›å»ºæˆåŠŸï¼å…±åˆ›å»º ' + (res.orderCount || 1) + ' ä¸ªè®¢å•');
                    window.location.href = '/order/list';
                } else if (res.needLogin) {
                    alert(res.message || 'è¯·å…ˆç™»å½•');
                    window.location.href = '/login.html'; // è·³è½¬ç™»å½•é¡µ
                } else {
                    alert(res.message || 'è®¢å•åˆ›å»ºå¤±è´¥');
                    $('#submitBtn').prop('disabled', false).text('æäº¤è®¢å•');
                }
            },
            error: function(xhr) {
                console.error('é”™è¯¯è¯¦æƒ…:', xhr.responseText); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                $('#submitBtn').prop('disabled', false).text('æäº¤è®¢å•');
            }
        });
    }
</script>
</body>
</html>

